<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Plus Podcast - Finanças</title>
    <style>
      :root {
        --cor-saldo: #1e88e5;
        --cor-entradas: #43a047;
        --cor-saidas: #e53935;
        --cor-fundo: #f5f5f5;
        --cor-texto: #263238;
        --cor-card: #ffffff;
        --cor-borda: #e0e0e0;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: var(--cor-fundo);
        color: var(--cor-texto);
      }

      header {
        background: linear-gradient(135deg, #0d47a1, #1976d2);
        color: #ffffff;
        padding: 1.5rem 2rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.75rem;
      }

      header h1 {
        margin: 0;
        font-size: 1.8rem;
        letter-spacing: 0.5px;
        text-align: center;
      }

      .usuario-barra {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 0.95rem;
      }

      .usuario-barra span {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
      }

      #usuarioPermissao {
        font-style: italic;
        opacity: 0.85;
      }

      .usuario-barra strong {
        font-weight: 600;
      }

      .usuario-barra button {
        background-color: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.4);
        color: #ffffff;
        padding: 0.35rem 0.85rem;
        border-radius: 999px;
        font-size: 0.85rem;
        cursor: pointer;
      }

      .usuario-barra button:hover {
        background-color: rgba(255, 255, 255, 0.35);
      }

      [hidden] {
        display: none !important;
      }

      #loginContainer {
        display: flex;
        justify-content: center;
        padding: 3rem 1.5rem;
      }

      .login-form {
        background-color: var(--cor-card);
        border-radius: 12px;
        padding: 2rem;
        width: 100%;
        max-width: 360px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .login-form h2 {
        margin: 0;
        text-align: center;
        font-size: 1.35rem;
      }

      .login-status {
        min-height: 1.5rem;
        font-size: 0.95rem;
        text-align: center;
      }

      .login-status.info {
        color: var(--cor-saldo);
      }

      .login-status.erro {
        color: var(--cor-saidas);
      }

      .login-status.sucesso {
        color: var(--cor-entradas);
      }

      main {
        max-width: 1100px;
        margin: 2rem auto;
        padding: 0 1.5rem 3rem;
        display: flex;
        flex-direction: column;
        gap: 2rem;
      }

      .cards-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1.5rem;
      }

      .controle-mes {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
      }

      .controle-mes label {
        font-weight: 600;
      }

      .controle-mes select {
        min-width: 180px;
        max-width: 260px;
      }

      .filtros-lancamentos {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        align-items: flex-end;
        margin-bottom: 1rem;
      }

      .filtros-lancamentos .grupo-filtro {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
      }

      .filtros-lancamentos .grupo-periodo {
        flex-direction: row;
        align-items: center;
        gap: 0.5rem;
      }

      .filtros-lancamentos .grupo-periodo label {
        margin-bottom: 0;
      }

      .filtros-lancamentos .grupo-periodo input {
        min-width: 150px;
      }

      .filtros-lancamentos button {
        align-self: center;
      }

      .card {
        background-color: var(--cor-card);
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        display: flex;
        flex-direction: column;
        gap: 0.6rem;
      }

      .card h3 {
        margin: 0;
        font-size: 1rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 600;
      }

      .card .valor {
        font-size: 1.8rem;
        font-weight: 700;
      }

      .card.saldo {
        border-left: 6px solid var(--cor-saldo);
      }

      .card.entrada {
        border-left: 6px solid var(--cor-entradas);
      }

      .card.saida {
        border-left: 6px solid var(--cor-saidas);
      }

      section {
        background-color: var(--cor-card);
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
      }

      section h2 {
        margin-top: 0;
        font-size: 1.4rem;
        margin-bottom: 1rem;
      }

      form {
        display: grid;
        gap: 1rem;
      }

      .form-row {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
      }

      .form-group {
        display: flex;
        flex-direction: column;
        flex: 1 1 180px;
        min-width: 180px;
      }

      label {
        font-weight: 600;
        margin-bottom: 0.4rem;
      }

      input[type='text'],
      input[type='date'],
      input[type='number'],
      select {
        padding: 0.6rem 0.75rem;
        border: 1px solid var(--cor-borda);
        border-radius: 8px;
        font-size: 1rem;
        transition: border 0.2s ease, box-shadow 0.2s ease;
      }

      input:focus,
      select:focus {
        border-color: var(--cor-saldo);
        outline: none;
        box-shadow: 0 0 0 3px rgba(30, 136, 229, 0.2);
      }

      button {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 8px;
        background-color: var(--cor-saldo);
        color: #ffffff;
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        align-self: flex-start;
        transition: background 0.2s ease, transform 0.2s ease;
      }

      button:hover:not(:disabled) {
        background-color: #1565c0;
        transform: translateY(-1px);
      }

      button:disabled {
        opacity: 0.7;
        cursor: not-allowed;
      }

      .categorias-lancamento {
        display: flex;
        flex-wrap: wrap;
        gap: 1.5rem;
      }

      .categoria-grupo {
        flex: 1 1 220px;
        min-width: 220px;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      .categoria-titulo {
        font-weight: 600;
        color: var(--cor-texto);
      }

      .grupo-botoes {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      .botao-categoria {
        background-color: #e3f2fd;
        color: #0d47a1;
        border: 1px solid #90caf9;
        padding: 0.55rem 1rem;
        font-size: 0.95rem;
        align-self: flex-start;
        transition: background 0.2s ease, color 0.2s ease, border 0.2s ease;
      }

      .botao-categoria:hover:not(:disabled) {
        background-color: #bbdefb;
        color: #0b3c91;
      }

      .botao-categoria.ativo {
        background-color: #0d47a1;
        color: #ffffff;
        border-color: #0d47a1;
      }

      .status-area {
        min-height: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 0.95rem;
      }

      .status-area span {
        display: none;
      }

      .status-area .ativo {
        display: inline-block;
      }

      .status-sucesso {
        color: var(--cor-entradas);
      }

      .status-erro {
        color: var(--cor-saidas);
      }

      .status-info {
        color: var(--cor-saldo);
      }

      .abas-navegacao {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        margin-bottom: 0;
      }

      .aba-botao {
        background-color: #e3f2fd;
        color: #0d47a1;
        border: 1px solid #90caf9;
        border-radius: 999px;
        align-self: center;
        padding: 0.6rem 1.25rem;
        transform: none;
        transition: background 0.2s ease, color 0.2s ease, border 0.2s ease;
      }

      .aba-botao:hover:not(:disabled) {
        background-color: #bbdefb;
        color: #0b3c91;
        transform: none;
      }

      .aba-botao.ativo {
        background-color: #0d47a1;
        color: #ffffff;
        border-color: #0d47a1;
      }

      .aba-botao:focus-visible {
        outline: 3px solid rgba(13, 71, 161, 0.35);
        outline-offset: 2px;
      }

      .aba-conteudo {
        display: none;
        flex-direction: column;
        gap: 2rem;
      }

      .aba-conteudo.ativo {
        display: flex;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        overflow: hidden;
      }

      thead {
        background-color: var(--cor-fundo);
      }

      th,
      td {
        padding: 0.75rem;
        text-align: left;
        border-bottom: 1px solid var(--cor-borda);
      }

      tbody tr.entrada td.valor {
        color: var(--cor-entradas);
        font-weight: 600;
      }

      tbody tr.saida td.valor {
        color: var(--cor-saidas);
        font-weight: 600;
      }

      tbody tr:nth-child(even) {
        background-color: rgba(0, 0, 0, 0.02);
      }

      .alerta-somente-leitura {
        background-color: rgba(13, 71, 161, 0.08);
        border-left: 4px solid var(--cor-saldo);
        padding: 0.75rem 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        font-size: 0.95rem;
      }

      .formulario-bloqueado {
        opacity: 0.75;
      }

      @media (min-width: 640px) {
        header {
          flex-direction: row;
          justify-content: space-between;
        }

        header h1 {
          text-align: left;
        }
      }

      @media (max-width: 600px) {
        header h1 {
          font-size: 1.4rem;
        }

        main {
          padding: 0 1rem 2rem;
        }

        th,
        td {
          font-size: 0.9rem;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Plus Podcast - Finanças</h1>
      <div id="usuarioBarra" class="usuario-barra" hidden>
        <span>Logado como <strong id="usuarioNome"></strong></span>
        <span id="usuarioPermissao"></span>
        <button type="button" id="botaoLogout">Sair</button>
      </div>
    </header>
    <div id="loginContainer" role="region" aria-label="Acesso ao sistema">
      <form id="formLogin" class="login-form">
        <h2>Acesso restrito</h2>
        <label for="loginUsuario">Usuário</label>
        <input id="loginUsuario" type="text" autocomplete="username" required />
        <label for="loginSenha">Senha</label>
        <input id="loginSenha" type="password" autocomplete="current-password" required />
        <div id="loginMensagem" class="login-status" role="status"></div>
        <button id="botaoLogin" type="submit">Entrar</button>
      </form>
    </div>
    <main id="appConteudo" hidden>
      <div class="abas-navegacao" role="tablist" aria-label="Navegação do aplicativo">
        <button
          type="button"
          id="abaResumoBotao"
          class="aba-botao ativo"
          data-alvo="abaResumo"
          role="tab"
          aria-selected="true"
          aria-controls="abaResumo"
          tabindex="0"
        >
          Resumo e lançamentos
        </button>
        <button
          type="button"
          id="abaConsultaBotao"
          class="aba-botao"
          data-alvo="abaConsulta"
          role="tab"
          aria-selected="false"
          aria-controls="abaConsulta"
          tabindex="-1"
        >
          Consulta de lançamentos
        </button>
      </div>

      <div id="abaResumo" class="aba-conteudo ativo" role="tabpanel" aria-labelledby="abaResumoBotao">
        <section aria-labelledby="resumo-titulo">
          <h2 id="resumo-titulo">Resumo Financeiro</h2>
          <div class="controle-mes">
            <label for="mesResumo">Selecionar mês</label>
            <select id="mesResumo" aria-label="Selecionar mês para o resumo"></select>
          </div>
          <div class="cards-container">
            <div class="card saldo">
              <h3>Saldo atual</h3>
              <span id="saldoAtual" class="valor">R$ 0,00</span>
            </div>
            <div class="card entrada">
              <h3>Total de Entradas</h3>
              <span id="totalEntradas" class="valor">R$ 0,00</span>
            </div>
            <div class="card saida">
              <h3>Total de Saídas</h3>
              <span id="totalSaidas" class="valor">R$ 0,00</span>
            </div>
          </div>
        </section>

        <section aria-labelledby="novo-titulo">
          <h2 id="novo-titulo">Novo Lançamento</h2>
          <p id="avisoSomenteLeitura" class="alerta-somente-leitura" hidden>
            Você está utilizando uma conta com permissão somente leitura. O envio de novos lançamentos está
            desabilitado para este perfil.
          </p>
          <form id="formLancamento">
            <div class="form-row">
              <div class="form-group">
                <label for="dataLancamento">Data</label>
                <input id="dataLancamento" type="date" required />
              </div>
            </div>
            <div class="categorias-lancamento" aria-label="Atalhos para descrição do lançamento">
              <div class="categoria-grupo">
                <span class="categoria-titulo">Entradas</span>
                <div class="grupo-botoes" data-grupo="entrada">
                  <button
                    type="button"
                    class="botao-categoria"
                    data-tipo="Entrada"
                    data-descricao="Patrocínio"
                    data-exige-detalhe="true"
                  >
                    Patrocínio
                  </button>
                  <button
                    type="button"
                    class="botao-categoria"
                    data-tipo="Entrada"
                    data-descricao="Aporte Bruno"
                  >
                    Aporte Bruno
                  </button>
                  <button
                    type="button"
                    class="botao-categoria"
                    data-tipo="Entrada"
                    data-descricao="Aporte Xandão"
                  >
                    Aporte Xandão
                  </button>
                  <button
                    type="button"
                    class="botao-categoria"
                    data-tipo="Entrada"
                    data-permite-livre="true"
                    data-focus="descricao"
                  >
                    Outro
                  </button>
                </div>
              </div>
              <div class="categoria-grupo">
                <span class="categoria-titulo">Saídas</span>
                <div class="grupo-botoes" data-grupo="saida">
                  <button type="button" class="botao-categoria" data-tipo="Saída" data-descricao="Scallet">
                    Scallet
                  </button>
                  <button type="button" class="botao-categoria" data-tipo="Saída" data-descricao="ADS">
                    ADS
                  </button>
                  <button type="button" class="botao-categoria" data-tipo="Saída" data-descricao="Social Monster">
                    Social Monster
                  </button>
                  <button type="button" class="botao-categoria" data-tipo="Saída" data-descricao="IA">
                    IA
                  </button>
                  <button type="button" class="botao-categoria" data-tipo="Saída" data-descricao="Instagram">
                    Instagram
                  </button>
                  <button type="button" class="botao-categoria" data-tipo="Saída" data-descricao="Studio">
                    Studio
                  </button>
                  <button
                    type="button"
                    class="botao-categoria"
                    data-tipo="Saída"
                    data-permite-livre="true"
                    data-focus="descricao"
                  >
                    Outro
                  </button>
                </div>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="descricaoLancamento">Descrição</label>
                <input id="descricaoLancamento" type="text" placeholder="Descrição do lançamento" required />
              </div>
              <div class="form-group">
                <label for="valorLancamento">Valor</label>
                <input id="valorLancamento" type="number" step="0.01" min="0" placeholder="0,00" required />
              </div>
            </div>
            <div class="status-area">
              <span id="statusInfo" class="status-info"></span>
              <span id="statusSucesso" class="status-sucesso"></span>
              <span id="statusErro" class="status-erro"></span>
            </div>
            <button id="salvarLancamento" type="submit">Salvar lançamento</button>
          </form>
        </section>
      </div>

      <div
        id="abaConsulta"
        class="aba-conteudo"
        role="tabpanel"
        aria-labelledby="abaConsultaBotao"
        hidden
      >
        <section aria-labelledby="recentes-titulo">
          <h2 id="recentes-titulo">Consulta de lançamentos</h2>
          <div class="filtros-lancamentos" aria-label="Filtros de lançamentos recentes">
            <div class="grupo-filtro">
              <label for="filtroLancamentosModo">Mostrar</label>
              <select id="filtroLancamentosModo">
                <option value="ultimos30">Últimos 30 dias</option>
                <option value="mes">Por mês</option>
                <option value="periodo">Período personalizado</option>
              </select>
            </div>
            <div class="grupo-filtro" id="grupoFiltroMes" hidden>
              <label for="filtroLancamentosMes">Mês</label>
              <select id="filtroLancamentosMes"></select>
            </div>
            <div class="grupo-filtro grupo-periodo" id="grupoFiltroPeriodo" hidden>
              <label for="filtroDataInicio">De</label>
              <input type="date" id="filtroDataInicio" />
              <label for="filtroDataFim">até</label>
              <input type="date" id="filtroDataFim" />
            </div>
            <button type="button" id="aplicarFiltroLancamentos">Aplicar</button>
          </div>
          <div class="tabela-container">
            <table id="tabelaLancamentos">
              <thead>
                <tr>
                  <th>Tipo</th>
                  <th>Data</th>
                  <th>Descrição</th>
                  <th class="valor">Valor</th>
                </tr>
              </thead>
              <tbody id="lancamentosBody"></tbody>
            </table>
          </div>
        </section>
      </div>
    </main>

    <script>
      const formatadorMoeda = new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL',
      });

      const NOMES_MESES = [
        'Janeiro',
        'Fevereiro',
        'Março',
        'Abril',
        'Maio',
        'Junho',
        'Julho',
        'Agosto',
        'Setembro',
        'Outubro',
        'Novembro',
        'Dezembro',
      ];

      const CHAVE_SESSAO = 'plusPodcastSessao';
      const PAPEL_SOMENTE_LEITURA = 'leitura';

      let tipoLancamentoAtual = 'Entrada';
      let sessaoAtual = null;
      let appInicializado = false;
      let cacheMesesDisponiveis = [];

      window.onload = function () {
        configurarInterfaceInicial();
        restaurarSessao();
      };

      function configurarInterfaceInicial() {
        const formularioLogin = document.getElementById('formLogin');
        if (formularioLogin && !formularioLogin.dataset.configurado) {
          formularioLogin.dataset.configurado = 'true';
          formularioLogin.addEventListener('submit', function (evento) {
            evento.preventDefault();
            realizarLogin();
          });
        }

        const botaoLogout = document.getElementById('botaoLogout');
        if (botaoLogout && !botaoLogout.dataset.configurado) {
          botaoLogout.dataset.configurado = 'true';
          botaoLogout.addEventListener('click', function () {
            realizarLogout(true, 'Sessão encerrada.');
          });
        }

        configurarNavegacaoAbas();
      }

      function configurarNavegacaoAbas() {
        const botoes = document.querySelectorAll('.aba-botao');
        if (!botoes.length) {
          return;
        }

        botoes.forEach(function (botao) {
          if (botao.dataset.configurado === 'true') {
            return;
          }
          botao.dataset.configurado = 'true';
          botao.addEventListener('click', function () {
            ativarAba(botao.dataset.alvo, botao);
          });
        });

        const botaoAtivo = document.querySelector('.aba-botao.ativo') || botoes[0];
        if (botaoAtivo) {
          ativarAba(botaoAtivo.dataset.alvo, botaoAtivo);
        }
      }

      function ativarAba(idAba, botaoReferencia) {
        if (!idAba) {
          return;
        }

        const abas = document.querySelectorAll('.aba-conteudo');
        abas.forEach(function (aba) {
          const ativa = aba.id === idAba;
          aba.classList.toggle('ativo', ativa);
          aba.hidden = !ativa;
        });

        const botoes = document.querySelectorAll('.aba-botao');
        botoes.forEach(function (botao) {
          const ativo = botao === botaoReferencia || botao.dataset.alvo === idAba;
          botao.classList.toggle('ativo', ativo);
          botao.setAttribute('aria-selected', ativo ? 'true' : 'false');
          botao.setAttribute('tabindex', ativo ? '0' : '-1');
        });

        if (idAba === 'abaConsulta' && sessaoAtual) {
          carregarLancamentos();
        }
      }

      function realizarLogin() {
        const usuarioInput = document.getElementById('loginUsuario');
        const senhaInput = document.getElementById('loginSenha');
        const botao = document.getElementById('botaoLogin');

        const usuario = usuarioInput ? usuarioInput.value.trim() : '';
        const senha = senhaInput ? senhaInput.value : '';

        if (!usuario || !senha) {
          mostrarMensagemLogin('Informe usuário e senha.', 'erro');
          return;
        }

        if (botao) {
          botao.disabled = true;
        }
        mostrarMensagemLogin('Autenticando...', 'info');

        google.script.run
          .withSuccessHandler(function (resposta) {
            if (botao) {
              botao.disabled = false;
            }
            if (resposta && resposta.success) {
              concluirLogin(resposta);
            } else {
              mostrarMensagemLogin(
                (resposta && resposta.message) || 'Não foi possível autenticar. Verifique seus dados.',
                'erro'
              );
            }
          })
          .withFailureHandler(function () {
            if (botao) {
              botao.disabled = false;
            }
            mostrarMensagemLogin('Não foi possível realizar o login. Tente novamente.', 'erro');
          })
          .login({ usuario: usuario, senha: senha });
      }

      function restaurarSessao() {
        const sessaoSalva = obterSessaoLocal();
        if (!sessaoSalva) {
          exibirTelaLogin();
          return;
        }

        mostrarMensagemLogin('Restaurando sessão...', 'info');

        google.script.run
          .withSuccessHandler(function (resposta) {
            if (resposta && resposta.success) {
              concluirLogin(resposta);
            } else {
              realizarLogout(true, (resposta && resposta.message) || 'Sessão expirada.');
            }
          })
          .withFailureHandler(function () {
            realizarLogout(true, 'Não foi possível validar a sessão. Faça login novamente.');
          })
          .validarSessao(sessaoSalva);
      }

      function concluirLogin(resposta) {
        if (!resposta || !resposta.success || !resposta.usuario) {
          mostrarMensagemLogin('Não foi possível autenticar. Verifique seus dados.', 'erro');
          return;
        }

        const usuarioInfo = resposta.usuario;
        sessaoAtual = {
          id: usuarioInfo.id,
          nome: usuarioInfo.nome || usuarioInfo.id,
          papel: usuarioInfo.papel || '',
          token: resposta.token,
        };

        salvarSessaoLocal(sessaoAtual);
        limparMensagemLogin();
        ocultarTelaLogin();

        const formularioLogin = document.getElementById('formLogin');
        if (formularioLogin) {
          formularioLogin.reset();
        }

        atualizarBarraUsuario();
        aplicarPermissoes();
        iniciarAplicacao();
      }

      function iniciarAplicacao() {
        if (!appInicializado) {
          definirDataPadrao();
          configurarSelecaoMes();
          configurarFormulario();
          configurarFiltroLancamentos();
          appInicializado = true;
        }

        carregarMesesDisponiveis();
        carregarLancamentos();
      }

      function realizarLogout(exibirMensagem, mensagem) {
        const sessaoAnterior = sessaoAtual;
        sessaoAtual = null;
        removerSessaoLocal();

        if (sessaoAnterior) {
          google.script.run.logout({ usuario: sessaoAnterior.id, token: sessaoAnterior.token });
        }

        aplicarPermissoes();
        atualizarBarraUsuario();

        const botaoResumo = document.getElementById('abaResumoBotao');
        if (botaoResumo) {
          ativarAba('abaResumo', botaoResumo);
        }

        exibirTelaLogin(exibirMensagem ? mensagem : null, exibirMensagem ? 'info' : null);
      }

      function atualizarBarraUsuario() {
        const barra = document.getElementById('usuarioBarra');
        if (!barra) {
          return;
        }

        if (!sessaoAtual) {
          barra.hidden = true;
          const nome = document.getElementById('usuarioNome');
          const permissao = document.getElementById('usuarioPermissao');
          if (nome) {
            nome.textContent = '';
          }
          if (permissao) {
            permissao.textContent = '';
          }
          return;
        }

        const nome = document.getElementById('usuarioNome');
        const permissao = document.getElementById('usuarioPermissao');
        if (nome) {
          nome.textContent = sessaoAtual.nome || sessaoAtual.id;
        }
        if (permissao) {
          permissao.textContent = sessaoAtual.papel === PAPEL_SOMENTE_LEITURA ? 'Somente leitura' : 'Administrador';
        }
        barra.hidden = false;
      }

      function exibirTelaLogin(mensagem, tipo) {
        const login = document.getElementById('loginContainer');
        const app = document.getElementById('appConteudo');
        const barra = document.getElementById('usuarioBarra');

        if (login) {
          login.hidden = false;
        }
        if (app) {
          app.hidden = true;
        }
        if (barra) {
          barra.hidden = true;
        }

        if (mensagem) {
          mostrarMensagemLogin(mensagem, tipo || 'info');
        } else {
          limparMensagemLogin();
        }
      }

      function ocultarTelaLogin() {
        const login = document.getElementById('loginContainer');
        const app = document.getElementById('appConteudo');

        if (login) {
          login.hidden = true;
        }
        if (app) {
          app.hidden = false;
        }
      }

      function mostrarMensagemLogin(mensagem, tipo) {
        const elemento = document.getElementById('loginMensagem');
        if (!elemento) {
          return;
        }
        elemento.textContent = mensagem || '';
        elemento.className = 'login-status';
        if (tipo) {
          elemento.classList.add(tipo);
        }
      }

      function limparMensagemLogin() {
        const elemento = document.getElementById('loginMensagem');
        if (!elemento) {
          return;
        }
        elemento.textContent = '';
        elemento.className = 'login-status';
      }

      function salvarSessaoLocal(sessao) {
        if (!sessao) {
          return;
        }
        const dados = {
          usuario: sessao.id,
          token: sessao.token,
        };
        localStorage.setItem(CHAVE_SESSAO, JSON.stringify(dados));
      }

      function obterSessaoLocal() {
        try {
          const armazenado = localStorage.getItem(CHAVE_SESSAO);
          if (!armazenado) {
            return null;
          }
          const dados = JSON.parse(armazenado);
          if (!dados || !dados.usuario || !dados.token) {
            return null;
          }
          return dados;
        } catch (erro) {
          return null;
        }
      }

      function removerSessaoLocal() {
        localStorage.removeItem(CHAVE_SESSAO);
      }

      function definirTipoLancamento(tipo) {
        if (tipo === 'Entrada' || tipo === 'Saída') {
          tipoLancamentoAtual = tipo;
        }
      }

      function obterTipoLancamentoAtual() {
        return tipoLancamentoAtual;
      }

      function inferirTipoDoBotao(botao) {
        if (!botao) {
          return tipoLancamentoAtual;
        }

        const tipoDireto = botao.dataset.tipo;
        if (tipoDireto === 'Entrada' || tipoDireto === 'Saída') {
          return tipoDireto;
        }

        const grupo = botao.closest('.grupo-botoes');
        if (!grupo) {
          return tipoLancamentoAtual;
        }

        if (grupo.dataset.grupo === 'entrada') {
          return 'Entrada';
        }

        if (grupo.dataset.grupo === 'saida') {
          return 'Saída';
        }

        return tipoLancamentoAtual;
      }

      function definirDataPadrao() {
        const hoje = new Date();
        const ano = hoje.getFullYear();
        const mes = String(hoje.getMonth() + 1).padStart(2, '0');
        const dia = String(hoje.getDate()).padStart(2, '0');
        const campoData = document.getElementById('dataLancamento');
        if (campoData) {
          campoData.value = `${ano}-${mes}-${dia}`;
        }
      }

      function carregarResumo(mesReferencia) {
        const seletorMes = document.getElementById('mesResumo');
        const filtro =
          mesReferencia || (seletorMes ? seletorMes.value : obterMesAtualInfo().valor);

        const requisicao = criarRequisicao({ mesReferencia: filtro });
        if (!requisicao) {
          return;
        }

        google.script.run
          .withSuccessHandler(preencherResumo)
          .withFailureHandler(function (erro) {
            if (tratarErroDeSessao(erro)) {
              return;
            }
            mostrarMensagem('Não foi possível carregar o resumo financeiro.', 'erro');
          })
          .getDashboardData(requisicao);
      }

      function preencherResumo(dados) {
        const saldo = document.getElementById('saldoAtual');
        const entradas = document.getElementById('totalEntradas');
        const saidas = document.getElementById('totalSaidas');

        if (saldo) {
          saldo.textContent = formatadorMoeda.format((dados && dados.saldoAtual) || 0);
        }
        if (entradas) {
          entradas.textContent = formatadorMoeda.format((dados && dados.totalEntradas) || 0);
        }
        if (saidas) {
          saidas.textContent = formatadorMoeda.format((dados && dados.totalSaidas) || 0);
        }
      }

      function carregarLancamentos() {
        const filtro = obterParametrosFiltroLancamentos();
        if (filtro.erro) {
          mostrarMensagem(filtro.erro, 'erro');
          exibirMensagemLancamentos(filtro.erro);
          return;
        }

        const parametros = Object.assign({ limite: 200 }, filtro.parametros || {});

        const requisicao = criarRequisicao(parametros);
        if (!requisicao) {
          exibirMensagemLancamentos('Faça login para visualizar os lançamentos.');
          return;
        }

        exibirMensagemLancamentos('Carregando lançamentos...');

        google.script.run
          .withSuccessHandler(preencherLancamentos)
          .withFailureHandler(function (erro) {
            if (tratarErroDeSessao(erro)) {
              return;
            }
            console.error('Não foi possível carregar os lançamentos.', erro);
            exibirMensagemLancamentos('Não foi possível carregar os lançamentos.');
          })
          .listarLancamentos(requisicao);
      }

      function configurarSelecaoMes() {
        const seletor = document.getElementById('mesResumo');
        if (!seletor || seletor.dataset.configurado === 'true') {
          return;
        }

        seletor.dataset.configurado = 'true';
        seletor.addEventListener('change', function () {
          carregarResumo(seletor.value);
        });
      }

      function carregarMesesDisponiveis() {
        const seletor = document.getElementById('mesResumo');
        if (!seletor) {
          return;
        }

        const valorAtual = seletor.value;
        const requisicao = criarRequisicao({});
        if (!requisicao) {
          return;
        }

        google.script.run
          .withSuccessHandler(function (meses) {
            preencherSeletorMeses(meses, valorAtual);
          })
          .withFailureHandler(function (erro) {
            if (tratarErroDeSessao(erro)) {
              return;
            }
            preencherSeletorMeses([], valorAtual);
          })
          .getMesesDisponiveis(requisicao);
      }

      function preencherSeletorMeses(meses, valorAnterior) {
        const seletor = document.getElementById('mesResumo');
        if (!seletor) {
          return;
        }

        const lista = Array.isArray(meses) && meses.length > 0 ? meses : [obterMesAtualInfo()];

        cacheMesesDisponiveis = lista.slice();

        seletor.innerHTML = '';

        lista.forEach(function (item) {
          const opcao = document.createElement('option');
          opcao.value = item.valor;
          opcao.textContent = item.rotulo;
          seletor.appendChild(opcao);
        });

        const existeAnterior = lista.some(function (item) {
          return item.valor === valorAnterior;
        });

        seletor.value = existeAnterior ? valorAnterior : lista[0].valor;

        preencherSeletorMesesLancamentos(lista);

        carregarResumo(seletor.value);
      }

      function preencherSeletorMesesLancamentos(meses) {
        const seletor = document.getElementById('filtroLancamentosMes');
        if (!seletor) {
          return;
        }

        const lista = Array.isArray(meses) && meses.length > 0 ? meses : [obterMesAtualInfo()];
        const valorAnterior = seletor.value;

        seletor.innerHTML = '';

        lista.forEach(function (item) {
          const opcao = document.createElement('option');
          opcao.value = item.valor;
          opcao.textContent = item.rotulo;
          seletor.appendChild(opcao);
        });

        const existeAnterior = lista.some(function (item) {
          return item.valor === valorAnterior;
        });

        seletor.value = existeAnterior ? valorAnterior : lista[0].valor;
      }

      function configurarFiltroLancamentos() {
        const seletorModo = document.getElementById('filtroLancamentosModo');
        const seletorMes = document.getElementById('filtroLancamentosMes');
        const botaoAplicar = document.getElementById('aplicarFiltroLancamentos');

        if (seletorModo && seletorModo.dataset.configurado !== 'true') {
          seletorModo.dataset.configurado = 'true';
          seletorModo.addEventListener('change', function () {
            atualizarExibicaoFiltroLancamentos();
            if (seletorModo.value === 'ultimos30') {
              carregarLancamentos();
            }
          });
        }

        if (seletorMes && seletorMes.dataset.configurado !== 'true') {
          seletorMes.dataset.configurado = 'true';
          seletorMes.addEventListener('change', function () {
            if ((seletorModo && seletorModo.value) === 'mes') {
              carregarLancamentos();
            }
          });
        }

        if (botaoAplicar && botaoAplicar.dataset.configurado !== 'true') {
          botaoAplicar.dataset.configurado = 'true';
          botaoAplicar.addEventListener('click', function () {
            carregarLancamentos();
          });
        }

        atualizarExibicaoFiltroLancamentos();
      }

      function atualizarExibicaoFiltroLancamentos() {
        const seletorModo = document.getElementById('filtroLancamentosModo');
        const grupoMes = document.getElementById('grupoFiltroMes');
        const grupoPeriodo = document.getElementById('grupoFiltroPeriodo');
        const modo = seletorModo ? seletorModo.value : 'ultimos30';

        if (grupoMes) {
          grupoMes.hidden = modo !== 'mes';
        }
        if (grupoPeriodo) {
          grupoPeriodo.hidden = modo !== 'periodo';
        }

        if (modo === 'mes') {
          preencherSeletorMesesLancamentos(cacheMesesDisponiveis);
        }
      }

      function obterParametrosFiltroLancamentos() {
        const seletorModo = document.getElementById('filtroLancamentosModo');
        const modo = seletorModo ? seletorModo.value : 'ultimos30';

        if (modo === 'mes') {
          const seletorMes = document.getElementById('filtroLancamentosMes');
          const mesSelecionado = seletorMes ? seletorMes.value : '';
          return {
            parametros: mesSelecionado ? { mesReferencia: mesSelecionado } : {},
          };
        }

        if (modo === 'periodo') {
          const campoInicio = document.getElementById('filtroDataInicio');
          const campoFim = document.getElementById('filtroDataFim');
          const inicio = campoInicio ? campoInicio.value : '';
          const fim = campoFim ? campoFim.value : '';

          if (!inicio || !fim) {
            return {
              erro: 'Informe as datas inicial e final para filtrar por período.',
            };
          }

          if (inicio > fim) {
            return {
              erro: 'A data inicial não pode ser maior que a data final.',
            };
          }

          return {
            parametros: {
              dataInicio: inicio,
              dataFim: fim,
            },
          };
        }

        return { parametros: {} };
      }

      function exibirMensagemLancamentos(mensagem) {
        const corpoTabela = document.getElementById('lancamentosBody');
        if (!corpoTabela) {
          return;
        }

        corpoTabela.innerHTML = '';

        const linha = document.createElement('tr');
        const coluna = document.createElement('td');
        coluna.colSpan = 4;
        coluna.textContent = mensagem;
        linha.appendChild(coluna);
        corpoTabela.appendChild(linha);
      }

      function preencherLancamentos(lancamentos) {
        const corpoTabela = document.getElementById('lancamentosBody');
        if (!corpoTabela) {
          return;
        }

        corpoTabela.innerHTML = '';

        const itens = Array.isArray(lancamentos) ? lancamentos.slice() : [];

        if (itens.length === 0) {
          exibirMensagemLancamentos('Nenhum lançamento encontrado.');
          return;
        }

        itens.forEach(function (item) {
          const linha = document.createElement('tr');
          linha.classList.add(item && item.tipo === 'Entrada' ? 'entrada' : 'saida');

          const colunaTipo = document.createElement('td');
          colunaTipo.textContent = item && item.tipo ? item.tipo : '-';

          const colunaData = document.createElement('td');
          const dataFonte = item ? item.data : null;
          const dataObj = dataFonte instanceof Date ? dataFonte : new Date(dataFonte);
          colunaData.textContent = formatarDataBrasileira(dataObj);

          const colunaDescricao = document.createElement('td');
          colunaDescricao.textContent = (item && item.descricao ? String(item.descricao) : '').trim() || '-';

          const colunaValor = document.createElement('td');
          colunaValor.classList.add('valor');
          const valorNumerico = obterValorNumerico(item ? item.valor : null);
          colunaValor.textContent = formatadorMoeda.format(valorNumerico);

          linha.appendChild(colunaTipo);
          linha.appendChild(colunaData);
          linha.appendChild(colunaDescricao);
          linha.appendChild(colunaValor);

          corpoTabela.appendChild(linha);
        });
      }

      function obterValorNumerico(valor) {
        if (typeof valor === 'number' && isFinite(valor)) {
          return valor;
        }
        const texto = valor === null || typeof valor === 'undefined' ? '' : String(valor);
        const normalizado = texto
          .replace(/\s/g, '')
          .replace(/R\$/gi, '')
          .replace(/\./g, '')
          .replace(',', '.');
        const numero = Number(normalizado);
        return isFinite(numero) ? numero : 0;
      }

      function formatarDataBrasileira(data) {
        if (!(data instanceof Date) || isNaN(data)) {
          return '-';
        }
        const dia = String(data.getDate()).padStart(2, '0');
        const mes = String(data.getMonth() + 1).padStart(2, '0');
        const ano = data.getFullYear();
        return `${dia}/${mes}/${ano}`;
      }

      function configurarFormulario() {
        const formulario = document.getElementById('formLancamento');
        if (!formulario || formulario.dataset.configurado === 'true') {
          return;
        }

        formulario.dataset.configurado = 'true';
        formulario.addEventListener('submit', function (evento) {
          evento.preventDefault();
          enviarLancamento();
        });
        configurarBotoesCategorias();
      }

      function configurarBotoesCategorias() {
        const botoes = document.querySelectorAll('.botao-categoria');
        if (!botoes.length) {
          return;
        }

        const inputDescricao = document.getElementById('descricaoLancamento');
        const inputValor = document.getElementById('valorLancamento');

        if (!inputDescricao || !inputValor) {
          return;
        }

        botoes.forEach(function (botao) {
          if (botao.dataset.configurado === 'true') {
            return;
          }
          botao.dataset.configurado = 'true';

          botao.addEventListener('click', function () {
            if (botao.disabled) {
              return;
            }

            const exigeDetalhe = botao.dataset.exigeDetalhe === 'true';
            const permiteLivre = botao.dataset.permiteLivre === 'true';
            const focoPreferencia = botao.dataset.focus || (permiteLivre ? 'descricao' : 'valor');
            let descricaoBase = botao.dataset.descricao || '';
            definirTipoLancamento(inferirTipoDoBotao(botao));

            if (exigeDetalhe) {
              const detalhe = prompt('Digite o patrocinador:');
              if (!detalhe) {
                return;
              }
              const detalheLimpo = detalhe.trim();
              if (!detalheLimpo) {
                return;
              }
              descricaoBase = `${descricaoBase} - ${detalheLimpo}`;
            }

            document.querySelectorAll('.grupo-botoes .botao-categoria').forEach(function (item) {
              item.classList.remove('ativo');
            });
            botao.classList.add('ativo');

            if (permiteLivre) {
              inputDescricao.value = '';
            } else if (descricaoBase) {
              inputDescricao.value = descricaoBase;
            } else {
              inputDescricao.value = '';
            }

            if (focoPreferencia === 'descricao') {
              inputDescricao.focus();
              if (typeof inputDescricao.select === 'function') {
                inputDescricao.select();
              }
            } else {
              inputValor.focus();
              if (typeof inputValor.select === 'function') {
                inputValor.select();
              }
            }
          });
        });
      }

      function enviarLancamento() {
        if (!sessaoAtual) {
          mostrarMensagem('Sessão expirada. Faça login novamente.', 'erro');
          return;
        }

        if (sessaoAtual.papel === PAPEL_SOMENTE_LEITURA) {
          mostrarMensagem('Seu usuário possui acesso somente leitura.', 'erro');
          return;
        }

        limparMensagens();

        const tipo = obterTipoLancamentoAtual();
        const data = document.getElementById('dataLancamento').value;
        const descricao = document.getElementById('descricaoLancamento').value.trim();
        const valor = Number(document.getElementById('valorLancamento').value);

        if (tipo !== 'Entrada' && tipo !== 'Saída') {
          mostrarMensagem('Escolha uma categoria de entrada ou saída para o lançamento.', 'erro');
          return;
        }

        if (!descricao) {
          mostrarMensagem('Informe uma descrição para o lançamento.', 'erro');
          return;
        }

        if (!valor || valor <= 0) {
          mostrarMensagem('Informe um valor maior que zero.', 'erro');
          return;
        }

        const botao = document.getElementById('salvarLancamento');
        if (botao) {
          botao.disabled = true;
        }
        mostrarMensagem('Salvando lançamento...', 'info');

        const novoLancamento = {
          tipo: tipo,
          data: data,
          descricao: descricao,
          valor: valor,
        };

        const requisicao = criarRequisicao({ lancamento: novoLancamento });
        if (!requisicao) {
          if (botao) {
            botao.disabled = false;
          }
          mostrarMensagem('Sessão expirada. Faça login novamente.', 'erro');
          return;
        }

        google.script.run
          .withSuccessHandler(function (resposta) {
            if (botao) {
              botao.disabled = false;
            }
            if (resposta && resposta.success) {
              mostrarMensagem(resposta.message || 'Lançamento adicionado com sucesso.', 'sucesso');
              document.getElementById('descricaoLancamento').value = '';
              document.getElementById('valorLancamento').value = '';
              carregarMesesDisponiveis();
              carregarLancamentos();
            } else {
              mostrarMensagem(
                (resposta && resposta.message) || 'Não foi possível adicionar o lançamento.',
                'erro'
              );
            }
          })
          .withFailureHandler(function (erro) {
            if (botao) {
              botao.disabled = false;
            }
            if (tratarErroDeSessao(erro)) {
              return;
            }
            mostrarMensagem('Ocorreu um erro ao salvar o lançamento.', 'erro');
          })
          .addLancamento(requisicao);
      }

      function criarRequisicao(payload) {
        if (!sessaoAtual) {
          return null;
        }
        const base = Object.assign({}, payload || {});
        base.sessao = {
          usuario: sessaoAtual.id,
          token: sessaoAtual.token,
        };
        return base;
      }

      function tratarErroDeSessao(erro) {
        const mensagem = extrairMensagemErro(erro);
        if (mensagem && mensagem.toLowerCase().includes('sessão inválida')) {
          realizarLogout(true, 'Sessão expirada. Faça login novamente.');
          return true;
        }
        return false;
      }

      function extrairMensagemErro(erro) {
        if (typeof erro === 'string') {
          return erro;
        }
        if (erro && typeof erro.message === 'string') {
          return erro.message;
        }
        return '';
      }

      function aplicarPermissoes() {
        const formulario = document.getElementById('formLancamento');
        if (!formulario) {
          return;
        }

        const somenteLeitura = sessaoAtual && sessaoAtual.papel === PAPEL_SOMENTE_LEITURA;
        const elementos = formulario.querySelectorAll('input, button, select, textarea');
        elementos.forEach(function (elemento) {
          if (elemento.id === 'statusInfo' || elemento.id === 'statusErro' || elemento.id === 'statusSucesso') {
            return;
          }
          if (elemento.tagName === 'BUTTON' || elemento.tagName === 'INPUT' || elemento.tagName === 'SELECT') {
            elemento.disabled = somenteLeitura;
          }
        });

        formulario.classList.toggle('formulario-bloqueado', !!somenteLeitura);

        const aviso = document.getElementById('avisoSomenteLeitura');
        if (aviso) {
          aviso.hidden = !somenteLeitura;
        }
      }

      function mostrarMensagem(mensagem, tipo) {
        limparMensagens();

        const mapaStatus = {
          sucesso: 'statusSucesso',
          erro: 'statusErro',
          info: 'statusInfo',
        };

        const elementoId = mapaStatus[tipo];
        if (!elementoId) {
          return;
        }

        const elemento = document.getElementById(elementoId);
        if (!elemento) {
          return;
        }
        elemento.textContent = mensagem;
        elemento.classList.add('ativo');
      }

      function limparMensagens() {
        ['statusSucesso', 'statusErro', 'statusInfo'].forEach(function (id) {
          const elemento = document.getElementById(id);
          if (!elemento) {
            return;
          }
          elemento.textContent = '';
          elemento.classList.remove('ativo');
        });
      }

      function obterMesAtualInfo() {
        const hoje = new Date();
        const ano = hoje.getFullYear();
        const mes = hoje.getMonth();
        return {
          valor: `${ano}-${String(mes + 1).padStart(2, '0')}`,
          rotulo: `${NOMES_MESES[mes]} de ${ano}`,
        };
      }
    </script>
  </body>
</html>
